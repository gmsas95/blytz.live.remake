services:
    frontend:
      build:
        context: ./frontend
        dockerfile: Dockerfile
      container_name: blytz-frontend
      restart: unless-stopped
      environment:
        VITE_API_URL: ${VITE_API_URL:-http://backend:8080/api/v1}
        VITE_APP_NAME: ${VITE_APP_NAME:-Blytz.app Marketplace}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-1.0.0}
        NODE_ENV: production
      networks:
        - blytz-network

    backend:
      build:
        context: ./backend
        dockerfile: Dockerfile
      container_name: blytz-backend
      restart: unless-stopped
      environment:
        DB_HOST: postgres
        DB_PORT: 5432
        DB_USER: ${DB_USER:-blytz_user}
        DB_PASSWORD: ${DB_PASSWORD}
        DB_NAME: ${DB_NAME:-blytz_marketplace}
        DB_SSL_MODE: disable
        REDIS_HOST: redis
        REDIS_PORT: 6379
        REDIS_PASSWORD: ${REDIS_PASSWORD}
        JWT_SECRET: ${JWT_SECRET}
        JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-168h}
        PORT: 8080
        CORS_ORIGINS: ${CORS_ORIGINS:-http://frontend:3000}
        ENVIRONMENT: production
        GEMINI_API_KEY: ${GEMINI_API_KEY}
      depends_on:
        postgres:
          condition: service_healthy
        redis:
          condition: service_healthy
      networks:
        - blytz-network

    postgres:
      image: postgres:15-alpine
      container_name: blytz-postgres
      restart: unless-stopped
      environment:
        POSTGRES_DB: ${DB_NAME:-blytz_marketplace}
        POSTGRES_USER: ${DB_USER:-blytz_user}
        POSTGRES_PASSWORD: ${DB_PASSWORD:-blytz_password_2024}
        POSTGRES_INITDB_ARGS: --encoding=UTF-8
      volumes:
        - postgres_data:/var/lib/postgresql/data
      networks:
        - blytz-network
      healthcheck:
        test:
          - CMD-SHELL
          - pg_isready -U blytz_user -d blytz_marketplace
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s

    redis:
      image: redis:7-alpine
      container_name: blytz-redis
      restart: unless-stopped
      command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
      volumes:
        - redis_data:/data
      networks:
        - blytz-network
      healthcheck:
        test:
          - CMD
          - redis-cli
          - ping
        interval: 10s
        timeout: 3s
        retries: 5
        start_period: 30s

volumes:
    postgres_data:
      driver: local
    redis_data:
      driver: local

networks:
    blytz-network:
      driver: bridge